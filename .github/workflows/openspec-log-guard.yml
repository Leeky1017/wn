name: openspec-log-guard

on:
  pull_request:
    types: [opened, synchronize, edited, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: read

jobs:
  guard:
    name: openspec-log-guard
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR metadata
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request in event payload");
              return;
            }

            const body = pr.body || "";
            const m = body.match(/Closes\s+#(\d+)/i);
            if (!m) {
              core.setFailed("PR body must contain: 'Closes #<issue-number>'");
              return;
            }

            const issueNumber = m[1];
            const headRef = pr.head.ref || "";
            if (!headRef.startsWith(`task/${issueNumber}-`)) {
              core.setFailed(`Branch must be 'task/${issueNumber}-<slug>', got: ${headRef}`);
              return;
            }

            const { owner, repo } = context.repo;
            const pull_number = pr.number;
            const expectedRunLog = `openspec/_ops/task_runs/ISSUE-${issueNumber}.md`;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            if (!files.some((f) => f.filename === expectedRunLog)) {
              core.setFailed(`PR must include run log file: ${expectedRunLog}`);
              return;
            }

            const commits = await github.paginate(github.rest.pulls.listCommits, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const missing = commits
              .map((c) => ({ sha: c.sha, message: c.commit?.message || "" }))
              .filter((c) => !c.message.includes(`(#${issueNumber})`));

            if (missing.length > 0) {
              core.setFailed(
                `All commit messages must include '(#${issueNumber})'. Missing: ${missing
                  .map((c) => c.sha.slice(0, 7))
                  .join(", ")}`
              );
              return;
            }
